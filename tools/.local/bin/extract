#!/usr/bin/env bash
#
# Extract an archive.

PROGRAM=$(basename "${0}")

usage() {
cat<<EOF
Extract an archive.

Usage:
  ${PROGRAM} FILE...

Options:
  -h  show this screen and exit
EOF
}

err() {
  printf "%s: cannot extract '%s'\n" "${PROGRAM}" "${@}" >&2
}

_un7zip() {
  local filename="${1}"
  local dir="${filename/%.7z}"
  mkdir -p "${dir}"
  7z x -o"${dir}" "${filename}"
}

_unrar() {
  local filename="${1}"
  local dir="${filename/%.rar}"
  mkdir -p "${dir}"
  unrar e "${filename}" "${dir}"
}

_untar() {
  local filename="${1}"
  dir="${filename%.tar*}"
  mkdir -p "${dir}"
  tar -xf "${filename}" -C "${dir}"
}

_unzip() {
  local filename="${1}"
  local dir="${filename/%.zip}"
  mkdir -p "${dir}"
  unzip "${filename}" -d "${dir}"
}

main() {
  while getopts 'h' opt; do
    case $opt in
      h)
        usage
        exit
        ;;
      *)
        usage
        exit 1
        ;;
    esac
  done

  [[ "$#" -eq 0 ]] && usage && exit 1

  for filename in "${@}"; do
    local mime_type="$(file --brief --mime-type "${filename}")"
    local subtype="${mime_type#*/}"

    case $subtype in
      x-7z-compressed)
        _un7zip "${filename}"
        ;;
      x-bzip2|x-compress|x-gzip|x-lzip|x-lzma|x-xz)
        _untar "${filename}"
        ;;
      x-rar)
        _unrar "${filename}"
        ;;
      x-tar)
        _untar "${filename}"
        ;;
      zip)
        _unzip "${filename}"
        ;;
      *)
        err "${filename}"
        exit 1
        ;;
    esac
  done
}

main "${@}"
