#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

PROGRAM=$(basename "${0}")

usage() {
  cat<<EOF
usage: ${PROGRAM}

Flush OS X DNS cache.

Options:
  -h  show this screen and exit
EOF
}

die() {
  printf "%s: %s\n" "${PROGRAM}" "${@}" >&2
  exit 1
}

# Flush OS X cache. Command varies by version:
# <https://support.apple.com/en-us/HT202516>.
flush() {
  local minor=$(sw_vers -productVersion | cut -d. -f2)
  local patch=$(sw_vers -productVersion | cut -d. -f3)

  if [[ $minor -ge 10 ]]; then
    if [[ $patch -ge 4 ]]; then
      killall -HUP mDNSResponder
    else
      discoveryutil mdnsflushcache
    fi
  elif [[ $minor -ge 7 ]]; then
    killall -HUP mDNSResponder
  else
    dscacheutil -flushcache
  fi
}

main() {
  while getopts 'h' opt; do
    case $opt in
      h)
        usage
        return
        ;;
      *)
        usage
        return 1
        ;;
    esac
  done

  shift $(( OPTIND-1 ))

  [[ $EUID -eq 0 ]] || die 'must be root'

  flush
}

main "${@}"
