#!/usr/bin/env bash
set -euo pipefail
IFS=$'\t\n'

# usage: ghi-label-and-comment [-c] [-m MESSAGE] LABEL ISSUE...
#
# Label and comment on GitHub issues.
#
# If the user does not provide a comment using `-m`, ghi-label-and-comment
# will read from standard input.
#
# If standard input is not available, it will prompt the user to edit the
# message using $EDITOR.
#
# options:
#
#   -m  comment
#   -c  close issue(s)

TEMP="$(mktemp -t tmp.XXXXX)"

usage() {
  sed '/# usage:/,$!d;/^\s*$/q' "${0}" | sed 's/#\s\?//'
}

cleanup() {
  rm "${TEMP}"
}

main() {
  local comment=
  local close=

  while getopts 'hcm:' opt; do
    case $opt in
      m)
        comment=$OPTARG
        ;;
      c)
        close='--close'
        ;;
      h)
        usage
        return
        ;;
      *)
        return 1
        ;;
    esac
  done

  shift $((OPTIND - 1))

  [[ $# -ge 2 ]] || { usage; return 1; }

  if [[ -z $comment ]]; then
    if [[ -t 0 ]]; then
      $EDITOR "${TEMP}"
    else
      cat - > "${TEMP}"
    fi
    comment="$(cat "${TEMP}")"
  fi

  label=$1

  ghi label "${@:2}" -a "${label}"

  for i in "${@:2}"; do
    ghi comment -m "${comment}" ${close} "${i}"
  done
}

trap cleanup EXIT

main "${@}"
