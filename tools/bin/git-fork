#!/usr/bin/env bash
#
# Fork a Git repository.

usage() {
  cat<<EOF
usage: git fork <repo>

Clone a repository and name the original remote 'upstream'.
EOF
}

fork() {
  local upstream=$1
  local repo="${upstream##*/}"
  repo="${repo/%.git/}"
  local origin
  local username
  local host

  case $repo in
    *github*)
      host='https://github.com'
      ;;
    *bitbucket*)
      host='https://bitbucket.com'
      ;;
    *)
      host='https://github.com'
      ;;
  esac

  username=$(git config --get credential.${host}.username)
  origin="${host}/${username}/${repo}"

  git clone -o upstream "${upstream}"
  cd "${repo}"
  git remote add origin "${origin}"
}

main() {
  while getopts 'h' opt; do
    case $opt in
      h)
        usage
        return
        ;;
      *)
        usage
        return 1
        ;;
    esac
  done
  [[ -z $1 ]] && { usage; return 1; }
  fork "${1}"
}

main "${@}"
